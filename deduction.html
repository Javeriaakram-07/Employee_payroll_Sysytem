<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Deduction Management | Payroll System</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-100 min-h-screen p-8 flex flex-col items-center">
    <h1 class="text-3xl font-extrabold text-[#0a2643] uppercase mb-8">
      Deduction Management
    </h1>

    <div class="w-full max-w-6xl space-y-10">
      <!-- ================= DEDUCTION MASTER ================= -->
      <section class="bg-white rounded-xl shadow-lg border p-6">
        <h2 class="text-xl font-bold text-[#0a2643] mb-4">Deduction Types</h2>

        <!-- Add Deduction -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <input
            id="deductType"
            placeholder="Deduction Type"
            class="border px-4 py-2 rounded-lg"
          />

          <input
            id="deductDesc"
            placeholder="Description"
            class="border px-4 py-2 rounded-lg"
          />

          <button
            onclick="addDeduction()"
            class="bg-[#0a2643] text-white rounded-lg px-6 py-2 font-semibold hover:bg-[#163a5f]"
          >
            Add Deduction
          </button>
        </div>

        <!-- Deduction Table -->
        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-[#0a2643] text-white">
                <th class="p-3 text-left">ID</th>
                <th class="p-3 text-left">Type</th>
                <th class="p-3 text-left">Description</th>
                <th class="p-3 text-center">Action</th>
              </tr>
            </thead>
            <tbody id="deductionTable"></tbody>
          </table>
        </div>
      </section>

      <!-- ================= ASSIGN DEDUCTION ================= -->
      <section class="bg-white rounded-xl shadow-lg border p-6">
        <h2 class="text-xl font-bold text-[#0a2643] mb-4">
          Assign Deduction to Employee
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <input
            id="empId"
            type="number"
            placeholder="Employee ID"
            class="border px-4 py-2 rounded-lg"
          />

          <input
            id="assignDeductId"
            type="number"
            placeholder="Deduction ID"
            class="border px-4 py-2 rounded-lg"
          />

          <input
            id="amount"
            type="number"
            placeholder="Amount"
            class="border px-4 py-2 rounded-lg"
          />

          <button
            onclick="assignDeduction()"
            class="bg-[#0a2643] text-white rounded-lg px-6 py-2 font-semibold hover:bg-[#163a5f]"
          >
            Assign
          </button>
        </div>

        <p id="msg" class="mt-3 text-sm"></p>
      </section>

      <!-- Back -->
      <div class="text-center">
        <button
          onclick="location.href='dashboard.html'"
          class="text-[#0a2643] font-semibold hover:underline"
        >
          ‚Üê Back to Dashboard
        </button>
      </div>
    </div>

    <!-- ================= SCRIPT ================= -->
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://vknwznfpuzxgzmgxvxvi.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrbnd6bmZwdXp4Z3ptZ3h2eHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0OTM5ODgsImV4cCI6MjA4NDA2OTk4OH0.Y7wX5fHQH_5jiUK5g7O8XanlsMDBqsOarmJA_aTTmxU"
      );

      const table = document.getElementById("deductionTable");
      const msg = document.getElementById("msg");

      /* ---------- LOAD DEDUCTIONS ---------- */
      async function loadDeductions() {
        const { data, error } = await supabase
          .from("deduction")
          .select("*")
          .order("deduct_id");

        table.innerHTML = "";

        if (error) {
          table.innerHTML = `<tr><td colspan="4" class="text-red-500 p-4">${error.message}</td></tr>`;
          return;
        }

        data.forEach((d) => {
          table.insertAdjacentHTML(
            "beforeend",
            `
            <tr class="border-b hover:bg-slate-50">
              <td class="p-3">${d.deduct_id}</td>
              <td class="p-3">${d.deduct_type}</td>
              <td class="p-3">${d.description || "-"}</td>
              <td class="p-3 text-center">
                <button onclick="deleteDeduction(${d.deduct_id})"
                  class="text-red-600 font-semibold hover:underline">
                  Delete
                </button>
              </td>
            </tr>
          `
          );
        });
      }

      loadDeductions();

      /* ---------- ADD DEDUCTION ---------- */
      window.addDeduction = async () => {
        const type = deductType.value.trim();
        const desc = deductDesc.value.trim();

        if (!type) {
          alert("Deduction type required");
          return;
        }

        const { error } = await supabase
          .from("deduction")
          .insert({ deduct_type: type, description: desc });

        if (error) alert(error.message);
        else {
          deductType.value = "";
          deductDesc.value = "";
          loadDeductions();
        }
      };

      /* ---------- DELETE DEDUCTION ---------- */
      window.deleteDeduction = async (id) => {
        if (!confirm("Delete this deduction?")) return;

        const { error } = await supabase
          .from("deduction")
          .delete()
          .eq("deduct_id", id);

        if (error) alert(error.message);
        else loadDeductions();
      };

      /* ---------- ASSIGN DEDUCTION ---------- */
      window.assignDeduction = async () => {
        const empId = document.getElementById("empId").value.trim();
        const deductId = document.getElementById("assignDeductId").value.trim();
        const amount = document.getElementById("amount").value.trim();

        msg.textContent = "";
        msg.className = "mt-3 text-sm";

        if (!empId || !deductId || !amount) {
          msg.textContent = "All fields are required";
          msg.classList.add("text-red-600");
          return;
        }

        const { error } = await supabase.from("employee_deduction").insert({
          emp_id: Number(empId),
          deduct_id: Number(deductId),
          amount: Number(amount),
        });

        if (error) {
          msg.textContent = error.message;
          msg.classList.add("text-red-600");
        } else {
          msg.textContent = "Deduction successfully assigned to employee";
          msg.classList.add("text-green-600");

          document.getElementById("empId").value = "";
          document.getElementById("assignDeductId").value = "";
          document.getElementById("amount").value = "";
        }
      };
    </script>
  </body>
</html>
