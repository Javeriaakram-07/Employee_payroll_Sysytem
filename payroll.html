<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payroll | Employee Payroll System</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-slate-100 min-h-screen p-6 md:p-12 flex flex-col items-center"
  >
    <h1
      class="text-3xl font-extrabold text-[#0d1b2a] uppercase tracking-tighter mb-8 text-center"
    >
      Payroll Records
    </h1>

    <div class="w-full max-w-6xl">
      <!-- Controls -->
      <div
        class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4"
      >
        <div
          class="flex flex-col md:flex-row items-center gap-3 w-full md:w-auto"
        >
          <input
            id="payMonth"
            type="month"
            class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#0d1b2a] outline-none w-full md:w-48 shadow-sm"
          />

          <button
            id="loadPayrollBtn"
            class="px-6 py-2 bg-[#0d1b2a] text-white font-semibold rounded-lg hover:bg-[#1b263b] transition shadow-md active:scale-95"
          >
            Load Payroll
          </button>
        </div>

        <button
          onclick="location.href='dashboard.html'"
          class="text-[#0d1b2a] font-semibold hover:underline flex items-center gap-1"
        >
          ‚Üê Back to Dashboard
        </button>
      </div>

      <!-- Payroll Table -->
      <div
        class="bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden"
      >
        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <thead>
              <tr
                class="bg-[#0d1b2a] text-white text-sm uppercase tracking-wider"
              >
                <th class="px-6 py-4 text-left font-bold">Payroll ID</th>
                <th class="px-6 py-4 text-left font-bold">Employee ID</th>
                <th class="px-6 py-4 text-left font-bold">Employee Name</th>
                <th class="px-6 py-4 text-left font-bold">Department</th>
                <th class="px-6 py-4 text-left font-bold">Job Title</th>
                <th class="px-6 py-4 text-right font-bold">Basic Salary</th>
                <th class="px-6 py-4 text-center font-bold">
                  Allowances (Count / Total)
                </th>
                <th class="px-6 py-4 text-center font-bold">
                  Deductions (Count / Total)
                </th>
                <th class="px-6 py-4 text-right font-bold">Net Salary</th>
                <th class="px-6 py-4 text-left font-bold">Pay Date</th>
              </tr>
            </thead>
            <tbody
              id="payrollTable"
              class="divide-y divide-slate-100 text-slate-700"
            >
              <tr>
                <td
                  colspan="10"
                  class="px-6 py-12 text-center text-slate-400 italic"
                >
                  Select month and click "Load Payroll" to view payroll records.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const SUPABASE_URL = "https://vknwznfpuzxgzmgxvxvi.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrbnd6bmZwdXp4Z3ptZ3h2eHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0OTM5ODgsImV4cCI6MjA4NDA2OTk4OH0.Y7wX5fHQH_5jiUK5g7O8XanlsMDBqsOarmJA_aTTmxU";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const btn = document.getElementById("loadPayrollBtn");

      async function loadPayroll() {
        const month = document.getElementById("payMonth").value;

        btn.innerText = "Loading...";
        btn.disabled = true;

        let query = supabase.from("vw_payroll_full").select("*");

        if (month) {
          // Filter by pay_date month/year
          query = query.eq("pay_date", month + "-01"); // adjust if pay_date is stored as DATE with first day of month
        }

        const { data, error } = await query.order("emp_id", {
          ascending: true,
        });

        if (error) {
          alert(error.message);
          btn.innerText = "Load Payroll";
          btn.disabled = false;
          return;
        }

        const tbody = document.getElementById("payrollTable");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-12 text-center">No payroll records found for this month.</td></tr>`;
        } else {
          data.forEach((p) => {
            const row = `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 text-sm font-bold">${
                              p.payroll_id ?? "-"
                            }</td>
                            <td class="px-6 py-4 text-sm">${p.emp_id}</td>
                            <td class="px-6 py-4 text-sm">${p.emp_name}</td>
                            <td class="px-6 py-4 text-sm">${p.dept_name}</td>
                            <td class="px-6 py-4 text-sm">${p.job_title}</td>
                            <td class="px-6 py-4 text-sm text-right">${
                              p.basic_salary?.toFixed(2) ?? "0.00"
                            }</td>
                            <td class="px-6 py-4 text-sm text-center">${
                              p.allowance_count ?? 0
                            } / ${p.total_allowance?.toFixed(2) ?? "0.00"}</td>
                            <td class="px-6 py-4 text-sm text-center">${
                              p.deduction_count ?? 0
                            } / ${p.total_deduction?.toFixed(2) ?? "0.00"}</td>
                            <td class="px-6 py-4 text-sm text-right">${
                              p.net_salary?.toFixed(2) ?? "0.00"
                            }</td>
                            <td class="px-6 py-4 text-sm">${p.pay_date}</td>
                        </tr>
                    `;
            tbody.insertAdjacentHTML("beforeend", row);
          });
        }

        btn.innerText = "Load Payroll";
        btn.disabled = false;
      }

      btn.addEventListener("click", loadPayroll);
    </script>
  </body>
</html>
